<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–ë—Ä–æ—Å–∞—é –∫—É—Ä–∏—Ç—å</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { 
      margin: 0; 
      font-family: system-ui, -apple-system, sans-serif;
      background: linear-gradient(to bottom, #f0fdf4, #d1fae5);
    }
    .message-enter {
      animation: slideIn 0.3s ease-out;
    }
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    .card-hover {
      transition: transform 0.2s;
    }
    .card-hover:active {
      transform: scale(0.98);
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script>
    const tg = window.Telegram?.WebApp;
    const BACKEND_URL = 'https://gristly-unshirred-kimberley.ngrok-free.dev'; // ‚ö†Ô∏è –ó–ê–ú–ï–ù–ò–¢–ï –Ω–∞ –≤–∞—à ngrok URL!
    
    let socket = null;
    let currentView = 'home';
    let messages = [];
    let partner = null;
    let inputValue = '';
    let isTyping = false;
    
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    let userProfile = {
      daysWithoutSmoking: 0,
      cigarettesPerDay: 20,
      pricePerPack: 200, // —Ä—É–±–ª–µ–π
      quitDate: new Date()
    };

    if (tg) {
      tg.ready();
      tg.expand();
      tg.setHeaderColor('#10b981');
      tg.setBackgroundColor('#f0fdf4');
    }

    const user = tg?.initDataUnsafe?.user || {
      id: Date.now(),
      first_name: '–¢–µ—Å—Ç–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'
    };

    // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è –∏–∑ localStorage
    function loadProfile() {
      const saved = localStorage.getItem(`profile_${user.id}`);
      if (saved) {
        const parsed = JSON.parse(saved);
        userProfile = {
          ...parsed,
          quitDate: new Date(parsed.quitDate)
        };
        
        // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –¥–Ω–∏
        const daysPassed = Math.floor((new Date() - userProfile.quitDate) / (1000 * 60 * 60 * 24));
        userProfile.daysWithoutSmoking = Math.max(0, daysPassed);
      }
    }

    function saveProfile() {
      localStorage.setItem(`profile_${user.id}`, JSON.stringify(userProfile));
    }

    // –†–∞—Å—á—ë—Ç—ã
    function calculateSavings() {
      const days = userProfile.daysWithoutSmoking;
      const cigarettesNotSmoked = days * userProfile.cigarettesPerDay;
      const packsNotSmoked = cigarettesNotSmoked / 20;
      const moneySaved = Math.floor(packsNotSmoked * userProfile.pricePerPack);
      
      return {
        days,
        cigarettesNotSmoked,
        moneySaved,
        hoursOfLife: Math.floor(cigarettesNotSmoked * 11 / 60), // 11 –º–∏–Ω—É—Ç –∂–∏–∑–Ω–∏ –∑–∞ —Å–∏–≥–∞—Ä–µ—Ç—É
        healthImprovement: getHealthStatus(days)
      };
    }

    function getHealthStatus(days) {
      if (days < 1) return { status: '–ù–∞—á–∞–ª–æ –ø—É—Ç–∏', description: '–ß–µ—Ä–µ–∑ 20 –º–∏–Ω—É—Ç –ø—É–ª—å—Å –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç—Å—è' };
      if (days < 2) return { status: '–ü–µ—Ä–≤—ã–π –¥–µ–Ω—å', description: '–ù–∏–∫–æ—Ç–∏–Ω –≤—ã–≤–æ–¥–∏—Ç—Å—è –∏–∑ –æ—Ä–≥–∞–Ω–∏–∑–º–∞' };
      if (days < 7) return { status: '–ü–µ—Ä–≤–∞—è –Ω–µ–¥–µ–ª—è', description: '–í–∫—É—Å –∏ –æ–±–æ–Ω—è–Ω–∏–µ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è' };
      if (days < 30) return { status: '–ü–µ—Ä–≤—ã–π –º–µ—Å—è—Ü', description: '–£–ª—É—á—à–∞–µ—Ç—Å—è —Ä–∞–±–æ—Ç–∞ –ª—ë–≥–∫–∏—Ö' };
      if (days < 90) return { status: '2-3 –º–µ—Å—è—Ü–∞', description: '–ö—Ä–æ–≤–æ–æ–±—Ä–∞—â–µ–Ω–∏–µ —É–ª—É—á—à–∞–µ—Ç—Å—è' };
      if (days < 365) return { status: '–î–æ –≥–æ–¥–∞', description: '–†–∏—Å–∫ –±–æ–ª–µ–∑–Ω–µ–π —Å–µ—Ä–¥—Ü–∞ —Å–Ω–∏–∂–∞–µ—Ç—Å—è –≤–¥–≤–æ–µ' };
      return { status: '–ë–æ–ª—å—à–µ –≥–æ–¥–∞', description: '–í—ã –º–æ–ª–æ–¥–µ—Ü! –ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –≤ —Ç–æ–º –∂–µ –¥—É—Ö–µ!' };
    }

    function getTips(days) {
      const allTips = [
        { day: 0, tip: 'üíß –ü–µ–π—Ç–µ –±–æ–ª—å—à–µ –≤–æ–¥—ã ‚Äî —ç—Ç–æ –ø–æ–º–æ–≥–∞–µ—Ç –≤—ã–≤–æ–¥–∏—Ç—å —Ç–æ–∫—Å–∏–Ω—ã –∏ —Å–ø—Ä–∞–≤–ª—è—Ç—å—Å—è —Å —Ç—è–≥–æ–π' },
        { day: 1, tip: 'üçé –î–µ—Ä–∂–∏—Ç–µ –ø–æ–¥ —Ä—É–∫–æ–π –ø–æ–ª–µ–∑–Ω—ã–µ –ø–µ—Ä–µ–∫—É—Å—ã: –æ—Ä–µ—Ö–∏, —Ñ—Ä—É–∫—Ç—ã, –∂–≤–∞—á–∫—É' },
        { day: 2, tip: 'üö∂ –ü—Ä–æ–≥—É–ª—è–π—Ç–µ—Å—å, –∫–æ–≥–¥–∞ —Ö–æ—á–µ—Ç—Å—è –∫—É—Ä–∏—Ç—å ‚Äî –¥–≤–∏–∂–µ–Ω–∏–µ –æ—Ç–≤–ª–µ–∫–∞–µ—Ç' },
        { day: 3, tip: 'üòÆ‚Äçüí® –î—ã—Ö–∞—Ç–µ–ª—å–Ω—ã–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è: –≥–ª—É–±–æ–∫–∏–π –≤–¥–æ—Ö –Ω–∞ 4 —Å—á—ë—Ç–∞, –≤—ã–¥–æ—Ö –Ω–∞ 6' },
        { day: 5, tip: 'üéØ –í—Å–ø–æ–º–Ω–∏—Ç–µ, –ó–ê–ß–ï–ú –≤—ã –±—Ä–æ—Å–∏–ª–∏ –∫—É—Ä–∏—Ç—å. –ó–∞–ø–∏—à–∏—Ç–µ —Å–≤–æ–∏ –ø—Ä–∏—á–∏–Ω—ã' },
        { day: 7, tip: 'üéâ –ù–µ–¥–µ–ª—è –±–µ–∑ –∫—É—Ä–µ–Ω–∏—è! –ù–∞–≥—Ä–∞–¥–∏—Ç–µ —Å–µ–±—è —á–µ–º-—Ç–æ –ø—Ä–∏—è—Ç–Ω—ã–º' },
        { day: 10, tip: '‚òïÔ∏è –ò–∑–±–µ–≥–∞–π—Ç–µ —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤: –∫–æ—Ñ–µ, –∞–ª–∫–æ–≥–æ–ª—å, –∫—É—Ä—è—â–∏—Ö –¥—Ä—É–∑–µ–π' },
        { day: 14, tip: 'üí™ –ù–∞—á–Ω–∏—Ç–µ –∑–∞–Ω–∏–º–∞—Ç—å—Å—è —Å–ø–æ—Ä—Ç–æ–º ‚Äî —ç—Ç–æ —Å–Ω–∏–∂–∞–µ—Ç —Ç—è–≥—É –∫ –∫—É—Ä–µ–Ω–∏—é' },
        { day: 21, tip: 'üß† –ü—Ä–∏–≤—ã—á–∫–∞ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è 21 –¥–µ–Ω—å. –í—ã –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø—É—Ç–∏!' },
        { day: 30, tip: 'üèÜ –ú–µ—Å—è—Ü –±–µ–∑ —Å–∏–≥–∞—Ä–µ—Ç! –í—ã –Ω–µ–≤–µ—Ä–æ—è—Ç–Ω—ã!' }
      ];

      const relevantTips = allTips.filter(t => days >= t.day).slice(-3);
      return relevantTips.length > 0 ? relevantTips : allTips.slice(0, 3);
    }

    loadProfile();

    // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WebSocket
    function connectWebSocket() {
      if (socket) return;

      socket = io(BACKEND_URL, {
        transports: ['websocket', 'polling']
      });

      socket.on('connect', () => {
        console.log('‚úÖ WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω');
        socket.emit('register', {
          telegram_id: user.id,
          name: user.first_name,
          days_without_smoking: userProfile.daysWithoutSmoking
        });
      });

      socket.on('searching', () => {
        console.log('‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –ø–∞—Ä—Ç–Ω–µ—Ä–∞...');
      });

      socket.on('partner_found', (data) => {
        console.log('‚ú® –ü–∞—Ä—Ç–Ω–µ—Ä –Ω–∞–π–¥–µ–Ω:', data.partner);
        partner = data.partner;
        messages = [{
          type: 'system',
          text: `–í—ã –ø–æ–¥–∫–ª—é—á–µ–Ω—ã. ${data.partner.name} –Ω–µ –∫—É—Ä–∏—Ç ${data.partner.days_without_smoking} –¥–Ω–µ–π`
        }];
        
        if (tg) {
          tg.MainButton.setText('–ó–∞–≤–µ—Ä—à–∏—Ç—å —á–∞—Ç');
          tg.MainButton.show();
          tg.MainButton.onClick(() => endChat());
          tg.HapticFeedback?.notificationOccurred('success');
        }
        
        currentView = 'chat';
        render();
      });

      socket.on('receive_message', (message) => {
        messages.push({
          type: 'partner',
          text: message.text,
          time: message.time
        });
        isTyping = false;
        render();
        scrollToBottom();
        
        if (tg) {
          tg.HapticFeedback?.impactOccurred('light');
        }
      });

      socket.on('partner_typing', () => {
        isTyping = true;
        render();
        setTimeout(() => {
          isTyping = false;
          render();
        }, 3000);
      });

      socket.on('partner_left', () => {
        messages.push({
          type: 'system',
          text: '–°–æ–±–µ—Å–µ–¥–Ω–∏–∫ –ø–æ–∫–∏–Ω—É–ª —á–∞—Ç'
        });
        render();
        
        setTimeout(() => {
          currentView = 'home';
          messages = [];
          partner = null;
          setupMainButton();
          render();
        }, 2000);
      });

      socket.on('disconnect', () => {
        console.log('‚ùå WebSocket –æ—Ç–∫–ª—é—á–µ–Ω');
      });
    }

    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≥–ª–∞–≤–Ω–æ–π –∫–Ω–æ–ø–∫–∏
    function setupMainButton() {
      if (!tg) return;
      
      tg.MainButton.setText('üí¨ –ù–∞–π—Ç–∏ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞');
      tg.MainButton.show();
      tg.MainButton.onClick(() => findPartner());
    }

    function setupBackButton() {
      if (!tg) return;
      
      tg.BackButton.show();
      tg.BackButton.onClick(() => {
        currentView = 'home';
        setupMainButton();
        render();
      });
    }

    // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    async function registerUser() {
      try {
        await fetch(`${BACKEND_URL}/api/user/register`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            telegram_id: user.id,
            name: user.first_name,
            days_without_smoking: userProfile.daysWithoutSmoking,
            motivation: '–•–æ—á—É –±—ã—Ç—å –∑–¥–æ—Ä–æ–≤—ã–º'
          })
        });
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:', error);
      }
    }

    // –ü–æ–∏—Å–∫ –ø–∞—Ä—Ç–Ω–µ—Ä–∞
    async function findPartner() {
      if (!socket) {
        connectWebSocket();
      }

      if (tg) {
        tg.MainButton.hide();
        setupBackButton();
        tg.HapticFeedback?.impactOccurred('medium');
      }

      await registerUser();
      
      currentView = 'searching';
      render();

      socket.emit('find_partner');
    }

    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
    function sendMessage() {
      const text = inputValue.trim();
      if (!text || !socket) return;

      const message = {
        text: text,
        time: new Date().toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' })
      };

      messages.push({
        type: 'user',
        ...message
      });

      socket.emit('send_message', message);
      inputValue = '';
      render();
      scrollToBottom();

      if (tg) {
        tg.HapticFeedback?.impactOccurred('light');
      }
    }

    // –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —á–∞—Ç–∞
    function endChat() {
      if (socket) {
        socket.emit('end_chat');
      }
      
      currentView = 'home';
      messages = [];
      partner = null;
      
      if (tg) {
        tg.BackButton.hide();
      }
      
      setupMainButton();
      render();
    }

    // –ù–∞—Å—Ç—Ä–æ–π–∫–∏
    function showSettings() {
      currentView = 'settings';
      if (tg) {
        tg.MainButton.hide();
        setupBackButton();
      }
      render();
    }

    function saveSettings(days, cigarettes, price) {
      userProfile.daysWithoutSmoking = parseInt(days) || 0;
      userProfile.cigarettesPerDay = parseInt(cigarettes) || 20;
      userProfile.pricePerPack = parseInt(price) || 200;
      userProfile.quitDate = new Date(Date.now() - userProfile.daysWithoutSmoking * 24 * 60 * 60 * 1000);
      
      saveProfile();
      currentView = 'home';
      
      if (tg) {
        tg.BackButton.hide();
      }
      
      setupMainButton();
      render();
    }

    // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑
    function scrollToBottom() {
      setTimeout(() => {
        const container = document.getElementById('messages-container');
        if (container) {
          container.scrollTop = container.scrollHeight;
        }
      }, 100);
    }

    // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥
    function render() {
      const root = document.getElementById('root');
      
      if (currentView === 'home') {
        const stats = calculateSavings();
        const tips = getTips(stats.days);

        root.innerHTML = `
          <div class="min-h-screen p-4 pb-24">
            <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
            <div class="text-center mb-6 pt-4">
              <div class="text-5xl mb-3">üö≠</div>
              <h1 class="text-2xl font-bold text-gray-800">–ü—Ä–∏–≤–µ—Ç, ${user.first_name}!</h1>
              <p class="text-gray-600 text-sm">–í—ã –Ω–∞ –ø—É—Ç–∏ –∫ –∑–¥–æ—Ä–æ–≤–æ–π –∂–∏–∑–Ω–∏</p>
            </div>

            <!-- –ì–ª–∞–≤–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
            <div class="bg-gradient-to-br from-green-500 to-emerald-600 rounded-3xl shadow-2xl p-6 mb-4 text-white">
              <div class="text-center mb-4">
                <div class="text-6xl font-bold mb-2">${stats.days}</div>
                <div class="text-lg opacity-90">${stats.days === 1 ? '–¥–µ–Ω—å' : stats.days < 5 ? '–¥–Ω—è' : '–¥–Ω–µ–π'} –±–µ–∑ –∫—É—Ä–µ–Ω–∏—è</div>
              </div>
              
              <div class="grid grid-cols-2 gap-3">
                <div class="bg-white bg-opacity-20 rounded-xl p-3 backdrop-blur">
                  <div class="text-2xl font-bold">${stats.moneySaved}‚ÇΩ</div>
                  <div class="text-xs opacity-90">–°—ç–∫–æ–Ω–æ–º–ª–µ–Ω–æ</div>
                </div>
                <div class="bg-white bg-opacity-20 rounded-xl p-3 backdrop-blur">
                  <div class="text-2xl font-bold">${stats.cigarettesNotSmoked}</div>
                  <div class="text-xs opacity-90">–ù–µ –≤—ã–∫—É—Ä–µ–Ω–æ</div>
                </div>
              </div>
            </div>

            <!-- –ó–¥–æ—Ä–æ–≤—å–µ -->
            <div class="bg-white rounded-2xl shadow-lg p-5 mb-4">
              <div class="flex items-center mb-3">
                <div class="text-3xl mr-3">ü´Å</div>
                <div>
                  <div class="font-bold text-gray-800">${stats.healthImprovement.status}</div>
                  <div class="text-sm text-gray-600">${stats.healthImprovement.description}</div>
                </div>
              </div>
              
              <div class="bg-blue-50 rounded-xl p-3 text-sm">
                <div class="flex justify-between mb-1">
                  <span class="text-gray-700">üí™ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ</span>
                  <span class="font-semibold text-blue-600">${Math.min(100, Math.floor(stats.days / 3.65))}%</span>
                </div>
                <div class="w-full bg-blue-200 rounded-full h-2">
                  <div class="bg-blue-600 h-2 rounded-full transition-all" style="width: ${Math.min(100, Math.floor(stats.days / 3.65))}%"></div>
                </div>
              </div>
            </div>

            <!-- –°–æ–≤–µ—Ç—ã -->
            <div class="bg-white rounded-2xl shadow-lg p-5 mb-4">
              <div class="flex items-center mb-3">
                <div class="text-2xl mr-2">üí°</div>
                <div class="font-bold text-gray-800">–°–æ–≤–µ—Ç—ã –¥–ª—è –≤–∞—Å</div>
              </div>
              
              ${tips.map(t => `
                <div class="bg-yellow-50 rounded-xl p-3 mb-2 text-sm text-gray-700">
                  ${t.tip}
                </div>
              `).join('')}
            </div>

            <!-- –ö–Ω–æ–ø–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ -->
            <button onclick="showSettings()" class="w-full bg-gray-100 text-gray-700 rounded-xl p-4 font-semibold card-hover mb-4">
              ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å
            </button>

            <!-- –ú–æ—Ç–∏–≤–∞—Ü–∏—è -->
            <div class="bg-gradient-to-r from-purple-100 to-pink-100 rounded-2xl p-4 text-center">
              <div class="text-lg font-semibold text-gray-800 mb-1">
                –í—ã –≤–µ—Ä–Ω—É–ª–∏ —Å–µ–±–µ ${stats.hoursOfLife} —á–∞—Å–æ–≤ –∂–∏–∑–Ω–∏! ‚è∞
              </div>
              <div class="text-sm text-gray-600">
                –ö–∞–∂–¥–∞—è —Å–∏–≥–∞—Ä–µ—Ç–∞ –æ—Ç–Ω–∏–º–∞–µ—Ç 11 –º–∏–Ω—É—Ç
              </div>
            </div>
          </div>
        `;

        // –î–µ–ª–∞–µ–º showSettings –¥–æ—Å—Ç—É–ø–Ω–æ–π –≥–ª–æ–±–∞–ª—å–Ω–æ
        window.showSettings = showSettings;

      } else if (currentView === 'settings') {
        root.innerHTML = `
          <div class="min-h-screen p-6">
            <div class="max-w-md mx-auto">
              <div class="text-center mb-6">
                <div class="text-4xl mb-3">‚öôÔ∏è</div>
                <h2 class="text-2xl font-bold text-gray-800">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è</h2>
              </div>

              <div class="bg-white rounded-2xl shadow-lg p-6 space-y-4">
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2">
                    –°–∫–æ–ª—å–∫–æ –¥–Ω–µ–π –±–µ–∑ –∫—É—Ä–µ–Ω–∏—è?
                  </label>
                  <input 
                    id="input-days"
                    type="number" 
                    value="${userProfile.daysWithoutSmoking}"
                    class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 text-lg focus:outline-none focus:border-green-500"
                    placeholder="0"
                  />
                </div>

                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2">
                    –°–∫–æ–ª—å–∫–æ —Å–∏–≥–∞—Ä–µ—Ç –∫—É—Ä–∏–ª–∏ –≤ –¥–µ–Ω—å?
                  </label>
                  <input 
                    id="input-cigarettes"
                    type="number" 
                    value="${userProfile.cigarettesPerDay}"
                    class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 text-lg focus:outline-none focus:border-green-500"
                    placeholder="20"
                  />
                </div>

                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2">
                    –¶–µ–Ω–∞ –ø–∞—á–∫–∏ (‚ÇΩ)
                  </label>
                  <input 
                    id="input-price"
                    type="number" 
                    value="${userProfile.pricePerPack}"
                    class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 text-lg focus:outline-none focus:border-green-500"
                    placeholder="200"
                  />
                </div>

                <button 
                  id="save-settings-btn"
                  class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-4 rounded-xl transition">
                  –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                </button>
              </div>
            </div>
          </div>
        `;

        setTimeout(() => {
          document.getElementById('save-settings-btn').addEventListener('click', () => {
            const days = document.getElementById('input-days').value;
            const cigarettes = document.getElementById('input-cigarettes').value;
            const price = document.getElementById('input-price').value;
            saveSettings(days, cigarettes, price);
          });
        }, 0);

      } else if (currentView === 'searching') {
        root.innerHTML = `
          <div class="min-h-screen flex flex-col items-center justify-center p-6">
            <div class="text-6xl mb-6 animate-pulse">üë•</div>
            <h2 class="text-2xl font-bold text-gray-800 mb-2">–ò—â–µ–º —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞...</h2>
            <p class="text-gray-600 text-center mb-6">–ü–æ–¥–±–∏—Ä–∞–µ–º —á–µ–ª–æ–≤–µ–∫–∞ —Å –ø–æ—Ö–æ–∂–∏–º –æ–ø—ã—Ç–æ–º</p>
            <div class="flex space-x-2 mb-8">
              <div class="w-3 h-3 bg-green-500 rounded-full animate-bounce"></div>
              <div class="w-3 h-3 bg-green-500 rounded-full animate-bounce" style="animation-delay: 150ms;"></div>
              <div class="w-3 h-3 bg-green-500 rounded-full animate-bounce" style="animation-delay: 300ms;"></div>
            </div>
            
            <div class="text-sm text-gray-500 text-center max-w-xs">
              üí° –ï—Å–ª–∏ –ø–æ–∏—Å–∫ –∑–∞—Ç—è–Ω—É–ª—Å—è, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ –∏–ª–∏ –ø—Ä–∏–≥–ª–∞—Å–∏—Ç–µ –¥—Ä—É–≥–∞ –≤ –±–æ—Ç
            </div>
          </div>
        `;
      } else if (currentView === 'chat') {
        const messagesHtml = messages.map((msg) => {
          if (msg.type === 'system') {
            return `
              <div class="text-center mb-4">
                <span class="bg-gray-200 text-gray-700 text-xs px-3 py-1 rounded-full">
                  ${msg.text}
                </span>
              </div>
            `;
          } else if (msg.type === 'user') {
            return `
              <div class="flex justify-end mb-3 message-enter">
                <div class="bg-green-500 text-white rounded-2xl rounded-tr-sm px-4 py-2 max-w-xs">
                  <p>${msg.text}</p>
                  <p class="text-xs text-green-100 mt-1">${msg.time}</p>
                </div>
              </div>
            `;
          } else if (msg.type === 'partner') {
            return `
              <div class="flex justify-start mb-3 message-enter">
                <div class="bg-white border border-gray-200 rounded-2xl rounded-tl-sm px-4 py-2 max-w-xs shadow">
                  <p class="text-gray-800">${msg.text}</p>
                  <p class="text-xs text-gray-500 mt-1">${msg.time}</p>
                </div>
              </div>
            `;
          }
        }).join('');

        const typingIndicator = isTyping ? `
          <div class="flex justify-start mb-3">
            <div class="bg-white border border-gray-200 rounded-2xl rounded-tl-sm px-4 py-2 shadow">
              <div class="flex space-x-1">
                <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
                <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 150ms;"></div>
                <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 300ms;"></div>
              </div>
            </div>
          </div>
        ` : '';

        root.innerHTML = `
          <div class="flex flex-col h-screen">
            <div class="bg-green-500 text-white p-4 shadow-lg">
              <div class="flex items-center space-x-3">
                <div class="w-12 h-12 bg-white rounded-full flex items-center justify-center text-2xl">
                  üë§
                </div>
                <div>
                  <p class="font-semibold">${partner?.name || '–°–æ–±–µ—Å–µ–¥–Ω–∏–∫'}</p>
                  <p class="text-sm text-green-100">${partner?.days_without_smoking || 0} –¥–Ω–µ–π –±–µ–∑ –∫—É—Ä–µ–Ω–∏—è</p>
                </div>
              </div>
            </div>

            <div id="messages-container" class="flex-1 overflow-y-auto p-4" style="padding-bottom: 80px;">
              ${messagesHtml}
              ${typingIndicator}
            </div>

            <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 p-4">
              <div class="flex space-x-2">
                <input 
                  id="message-input"
                  type="text" 
                  value="${inputValue}"
                  placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."
                  class="flex-1 border border-gray-300 rounded-full px-4 py-2 focus:outline-none focus:border-green-500"
                />
                <button 
                  id="send-button"
                  class="bg-green-500 hover:bg-green-600 text-white rounded-full px-6 py-2 font-semibold transition ${!inputValue.trim() ? 'opacity-50' : ''}"
                  ${!inputValue.trim() ? 'disabled' : ''}>
                  ‚û§
                </button>
              </div>
            </div>
          </div>
        `;

        setTimeout(() => {
          const input = document.getElementById('message-input');
          const sendBtn = document.getElementById('send-button');

          if (input) {
            input.focus();
            input.addEventListener('input', (e) => {
              inputValue = e.target.value;
              render();
              
              if (socket && inputValue.trim()) {
                socket.emit('typing');
              }
            });

            input.addEventListener('keypress', (e) => {
              if (e.key === 'Enter') {
                sendMessage();
              }
            });
          }

          if (sendBtn) {
            sendBtn.addEventListener('click', sendMessage);
          }

          scrollToBottom();
        }, 0);
      }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    setupMainButton();
    render();
  </script>
</body>
</html>